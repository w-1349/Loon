#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import requests
import re
from datetime import datetime, timedelta

# â€”â€” æ ¸å¿ƒé…ç½®åŒº â€”â€”
# ä½¿ç”¨ GitHub Raw é“¾æ¥ç¡®ä¿ç¨³å®šæ€§
RULE_SOURCES = [
    {"name": "AdRules", "url": "https://raw.githubusercontent.com/Cats-Team/AdRules/main/adrules.list"},
    {"name": "anti-ad", "url": "https://anti-ad.net/surge2.txt"}
]
OUTPUT_FILE = "Loon_rules.txt"

def get_beijing_time():
    """è·å–åŒ—äº¬æ—¶é—´ç”¨äºæŠ¥è¡¨å±•ç¤º"""
    return (datetime.utcnow() + timedelta(hours=8)).strftime('%Y-%m-%d %H:%M:%S')

def process_to_loon_format(line):
    """
    æ ¸å¿ƒæ¸…æ´—é€»è¾‘ï¼š
    1. è¯†åˆ«åŸå§‹å‰ç¼€ï¼šå¸¦ç‚¹(.)è½¬ DOMAIN-SUFFIXï¼Œä¸å¸¦ç‚¹è½¬ DOMAIN
    2. å‰”é™¤æ‰€æœ‰ Adblock è¯­æ³•ç¬¦å·å’Œéæ³•å¹²æ‰°é¡¹
    """
    line = line.strip()
    
    # åŸºç¡€è¿‡æ»¤ï¼šè·³è¿‡ç©ºè¡Œã€æ³¨é‡Šã€è§„åˆ™é›†æ ‡é¢˜ã€æ­£åˆ™ã€å¸¦$çš„å¤æ‚ä¿®é¥°ç¬¦
    if not line or line.startswith(('!', '#', '[')) or '/' in line or '$' in line:
        return None

    # ã€å…³é”®é€»è¾‘ã€‘åˆ¤æ–­åŸå§‹è¡Œæ˜¯å¦ä»¥ç‚¹å¼€å¤´ (é’ˆå¯¹ anti-ad ç­‰æº)
    # æˆ–è€…æœ¬æ¥å°±æ˜¾å¼åŒ…å« DOMAIN-SUFFIX
    is_suffix = line.startswith('.') or "DOMAIN-SUFFIX" in line
    
    # æå–åŸŸåä¸»ä½“ï¼šå‰¥ç¦»å‰ç¼€ç¬¦å· (|| æˆ– @@||)
    temp = line
    if temp.startswith('@@||'): temp = temp[4:]
    elif temp.startswith('||'): temp = temp[2:]
    
    # å¦‚æœæ˜¯åŸæœ¬å°±å¸¦å‰ç¼€çš„æ ¼å¼ (DOMAIN-SUFFIX,example.com)ï¼Œæå–å‡º example.com
    if ',' in temp:
        parts = temp.split(',')
        for part in parts:
            p = part.strip()
            if '.' in p and not p.isupper():
                temp = p
                break
    
    # å½»åº•å‡€åŒ–åŸŸåï¼šå»é™¤å·¦ä¾§æ‰€æœ‰ç‚¹ã€è½¬å°å†™ã€æˆªæ–­ç«¯å£å’Œè¡Œå°¾ç¬¦å·
    domain = temp.lstrip('.').lower().split('^')[0].split(':')[0].split('/')[0]

    # åˆæ³•æ€§æ ¡éªŒï¼šå¿…é¡»åŒ…å«ç‚¹å·ï¼Œä¸”å­—ç¬¦åˆæ³•
    if not ('.' in domain and re.match(r'^[a-z0-9\-\.]+$', domain)):
        return None
    
    # æ’é™¤çº¯ IP åœ°å€ï¼Œé˜²æ­¢è§£æé”™è¯¯
    if domain.split('.')[-1].isdigit():
        return None

    # â€”â€” æ ¹æ®é€»è¾‘è¾“å‡ºå¯¹åº”æ ¼å¼ â€”â€”
    if is_suffix:
        return f"DOMAIN-SUFFIX,{domain}"
    else:
        return f"DOMAIN,{domain}"

def main():
    all_rules = []
    source_stats = []
    
    print("ğŸš€ å¼€å§‹è½¬æ¢è§„åˆ™ï¼šæ­£åœ¨æ‰§è¡Œã€å¸¦ç‚¹è½¬ SUFFIX / æ— ç‚¹è½¬ DOMAINã€‘é€»è¾‘...")

    for src in RULE_SOURCES:
        try:
            print(f"ğŸ“¥ æ­£åœ¨æ‹‰å–: {src['name']}...")
            resp = requests.get(src['url'], timeout=30)
            lines = resp.text.splitlines()
            
            # æ‰§è¡Œè½¬æ¢
            formatted_list = [r for r in (process_to_loon_format(l) for l in lines) if r]
            # æºå†…å»é‡
            unique_src = list(dict.fromkeys(formatted_list))
            
            source_stats.append({
                "name": src['name'],
                "url": src['url'],
                "raw": len(lines),
                "unique": len(unique_src)
            })
            all_rules.extend(unique_src)
        except Exception as e:
            print(f"âŒ {src['name']} è·å–å¤±è´¥: {e}")

    # å…¨å±€å»é‡å¹¶æ’åº
    final_rules = sorted(list(set(all_rules)))
    duplicate_count = len(all_rules) - len(final_rules)

    # æ„å»ºå¸¦ç»Ÿè®¡ä¿¡æ¯çš„æŠ¥è¡¨å¤´éƒ¨
    beijing_time = get_beijing_time()
    header = [
        f"# Loon åŸŸåé›†åˆ (ç¨³å¥è½¬æ¢ç‰ˆ)",
        f"# ç”Ÿæˆæ—¶é—´: {beijing_time} (åŒ—äº¬æ—¶é—´)",
        f"# é€»è¾‘è¯´æ˜: åŸå§‹å¸¦ç‚¹ -> DOMAIN-SUFFIX | åŸå§‹æ— ç‚¹ -> DOMAIN",
        f"# æœ€ç»ˆæ€»æ•°: {len(final_rules)} æ¡",
        "# " + "="*65,
        "# ã€åˆ†æºæå–ç»Ÿè®¡ã€‘"
    ]
    for s in source_stats:
        header.append(f"# - {s['name']}: åŸå§‹è¡Œ {s['raw']} | æœ‰æ•ˆå»é‡é¡¹ {s['unique']}")
    
    header.append(f"# ã€å…¨å±€å»é‡æ±‡æ€»ã€‘: è·¨æºå…±å‰”é™¤ {duplicate_count} æ¡é‡å¤è§„åˆ™")
    header.append("# " + "="*65 + "\n")

    # å†™å…¥æœ€ç»ˆæ–‡ä»¶
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
        f.write('\n'.join(header))
        f.write('\n'.join(final_rules))

    print(f"âœ… å¤„ç†å®Œæˆï¼å·²ç”Ÿæˆ {OUTPUT_FILE}")

if __name__ == "__main__":
    main()
